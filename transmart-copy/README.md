# transmart-copy

Data uploader tool for [TranSMART](../), specifically for PostgreSQL databases.
For loading the observations data, it uses the `COPY` command, hence the name `transmart-copy`.

### Download
The latest version can be downloaded here:
[transmart-copy.jar](https://github.com/thehyve/transmart-core/releases/download/v17.1-rc.X/transmart-copy-17.1-RCX.jar).

```bash
# Download transmart-copy
curl -L https://github.com/thehyve/transmart-core/releases/download/v17.1-rc.X/transmart-copy-17.1-RCX.jar -o transmart-copy.jar
```

### Usage
_Usage:_
```bash
java -jar transmart-copy.jar [-h|--help] [--delete <STUDY_ID>]
```

_Parameters:_
- `-h`, `--help`: Shows the available parameters. 
- `-d <STUDY_ID>`, `--delete <STUDY_ID`: Deletes the study with id `<STUDY_ID>` and related data.

The program reads table data from the current working directory
and inserts new rows into the database if a row with the same identifier
does not yet exist.
The input directory should have the same structure as the database:
two directories `i2b2metadata` and `i2b2demodata` representing the schemas,
containing `.tsv` files for each of the tables.
See the [example directory](src/main/resources/examples/SURVEY0) for an example of the directory structure.

For shared data (used across studies), the identifiers of existing records are fetched first.
If a record already exists, the data is not updated. The tool
only adds new records.

For patients, studies, trial visits, dimension descriptions and relation types,
identifiers are generated by the database. In the `.tsv` files, an index
should be used in these columns. E.g., the first data row has the number
`0` in the identifier column instead of the identifier.
We always assume the first row to have the column names, exactly matching
the columns that exist in the database.

If a study in the input data already exists in the database, the program
aborts.

#### Identifying columns for shared data

For shared data, the following columns are used to identify if a record already exists:

| Table | Column(s) |
|:----- |:--------- |
| `patient_dimension`| the `patient_ide` and `patient_ide_source` columns of `patient_mapping` are used. |
| `concept_dimension` | `concept_cd` |
| `study` | `study_id` |
| `i2b2_secure` | `path` |
| `i2b2_tags` | `(path, tag_type, tags_idx)` |
| `relation_type` | `label` |

Observations are inserted without checking, because it is assumed that no
data for the study is present.

For relations data, the `relation` table is first truncated, and then
the data from `relation.tsv` is loaded. 
 

#### Deleting a study

With the `--delete` parameter, a study and associated data (trial visits, observations)
can be deleted from the database.


#### Database settings
The database settings are read from the environment variables:
- `PGHOST`: the hostname of the database server (default: `localhost`)
- `PGPORT`: the database server port (default: `5432`)
- `PGDATABASE`: the database name (default: `transmart`)
- `TM_CZ_PWD`: the password of the `tm_cz` user (default: `tm_cz`)



### Build and run from source
```bash
gradle shadowJar
./transmart-copy.sh [-h|--help] [--delete <STUDY_ID>]
```
